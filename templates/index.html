<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Marker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/topbar.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/Group59.png') }}">
</head>
<body>
    <!-- Top Bar -->
    <div class="topbar">
        <div class="topbar-logo">
            <img src="{{ url_for('static', filename='img/Group59.png') }}" alt="Logo" class="logo-img" style="max-height: 40px;" />
        </div>
        <div class="topbar-actions">
            <button class="btn btn-secondary" id="exportSettingsBtn">Export Settings</button>
            <button class="btn btn-outline-info" id="offsetBtn">Offset Time</button>
            <input type="file" id="cueFileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display:none;">
            <div id="cueActions" style="display:none;">
                <button class="btn btn-outline-primary btn-sm me-2" id="loadStructureBtn">Load Structure Only</button>
                <button class="btn btn-outline-success btn-sm" id="loadDataBtn">Load Data</button>
            </div>
            <button class="btn btn-outline-light" id="loadCueBtn">Load CSV/Excel</button>
        </div>
    </div>
    <div class="app-container">
        <!-- Video Player Section -->
        <div class="video-section" id="videoSection">
            <div class="video-container">
                <video id="videoPlayer" controls>
                    <source src="" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
            </div>
            <div class="controls mt-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" id="tcrInBtn">TCR In</button>
                    <button type="button" class="btn btn-primary" id="tcrOutBtn">TCR Out</button>
                </div>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="singleButtonMode">
                    <label class="form-check-label" for="singleButtonMode">Single Button Mode</label>
                </div>
                <div class="video-upload-controls mt-2">
                    <button type="button" class="btn btn-secondary" id="loadVideoBtn">Load Local Video</button>
                    <input type="file" id="videoFileInput" accept="video/mp4" style="display: none;">
                    <div class="input-group mt-2">
                        <input type="text" class="form-control" id="videoUrlInput" placeholder="Enter video URL">
                        <button class="btn btn-primary" type="button" id="loadUrlBtn">Load URL</button>
                    </div>
                </div>
            </div>
            <div class="resize-handle horizontal" id="videoSectionResize"></div>
        </div>
        <div class="stacked-resize-handle" id="stackedResizeHandle" style="display:none;"></div>
        <!-- Marker Table Section -->
        <div class="marker-section" id="markerSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <div>
                    <button class="btn btn-primary" id="addColumnBtn" style="margin-right: 1em;">Add Column</button>
                </div>
                <div style="display: flex; align-items: center;">
                    <label for="viewMode" style="margin-right: 0.5em; font-weight: 500;">View:</label>
                    <select id="viewMode" class="form-select" style="width: 200px; max-width: 200px;">
                        <option value="side-by-side">Side by Side</option>
                        <option value="stacked">Video Above, Table Below</option>
                    </select>
                </div>
            </div>
            <div class="export-buttons mb-3">
                <button class="btn btn-warning" id="rowMarkBtn">Mark Rows</button>
                <button class="btn btn-primary ms-2" id="exportBtn">Export</button>
                <button class="btn btn-danger ms-2" id="clearTableBtn">Clear Table</button>
                <button class="btn btn-danger ms-2" id="deleteSelectedBtn">Delete Selected</button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th class="seq" data-field="seq">#Seq</th>
                            <th class="tcr" data-field="tcrIn">TCR In</th>
                            <th class="tcr" data-field="tcrOut">TCR Out</th>
                            <th class="tcr" data-field="duration">Duration</th>
                            <th class="usage" data-field="usage">Usage</th>
                            <th class="special" data-field="title">Title</th>
                            <th class="special" data-field="filmTitle">Film/Album Title</th>
                            <th class="special" data-field="composer">Composer</th>
                            <th class="special" data-field="lyricist">Lyricist</th>
                            <th class="special" data-field="musicCo">Music Co</th>
                            <th class="special" data-field="nocId">NOC ID</th>
                            <th class="special" data-field="nocTitle">NOC Title</th>
                            <th class="recognize">Recognize</th>
                        </tr>
                    </thead>
                    <tbody id="markerTableBody">
                    </tbody>
                </table>
            </div>
            <div class="resize-handle horizontal" id="markerSectionResize"></div>
        </div>
    </div>

    <!-- Offset Modal -->
    <div class="offset-modal" id="offsetModal">
        <div class="offset-modal-content">
            <div class="offset-modal-header">
                <h4>Adjust Time Offset</h4>
                <span class="offset-modal-close">&times;</span>
            </div>
            <div class="offset-modal-body">
                <div class="mb-3">
                    <label for="offsetTime" class="form-label">Enter time offset in format: HH:MM:SS.mmm</label>
                    <input type="text" class="form-control" id="offsetTime" placeholder="00:00:05.000" value="00:00:05.000">
                </div>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="offsetDirection" id="offsetAdd" value="add" checked>
                        <label class="form-check-label" for="offsetAdd">
                            Add time (positive offset)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="offsetDirection" id="offsetSubtract" value="subtract">
                        <label class="form-check-label" for="offsetSubtract">
                            Subtract time (negative offset)
                        </label>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" id="applyOffset">Apply Offset</button>
            </div>
        </div>
    </div>

    <div id="rowMarkModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Mark Selected Rows</h2>
            <div class="mark-options">
                <button class="mark-btn yellow">Mark Yellow</button>
                <button class="mark-btn red">Mark Red</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}?v=2"></script>
    <script>
        // Initialize VLC player
        function initVLCPlayer() {
            const videoContainer = document.querySelector('.video-container');
            const videoElement = document.getElementById('videoPlayer');
            
            // Create VLC player instance
            const vlcPlayer = new VLCPlayer({
                container: videoContainer,
                video: videoElement,
                autoplay: false,
                controls: false,  // We'll use our custom controls
                onReady: () => {
                    console.log('VLC player ready');
                },
                onError: (error) => {
                    console.error('VLC player error:', error);
                }
            });

            // Override the existing video player functions to use VLC
            window.loadVideo = function(videoPath) {
                currentVideo = videoPath;
                fetch('/api/vlc/play', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ video_path: videoPath })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isPlaying = true;
                        if (!updateInterval) {
                            updateInterval = setInterval(updateProgress, 1000);
                        }
                    }
                })
                .catch(error => console.error('Error playing video:', error));
            };

            // Update the existing control functions to use VLC
            document.getElementById('playBtn').onclick = () => {
                fetch('/api/vlc/play', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ video_path: currentVideo })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isPlaying = true;
                        if (!updateInterval) {
                            updateInterval = setInterval(updateProgress, 1000);
                        }
                    }
                })
                .catch(error => console.error('Error playing video:', error));
            };

            document.getElementById('pauseBtn').onclick = () => {
                fetch('/api/vlc/pause', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isPlaying = false;
                    }
                })
                .catch(error => console.error('Error pausing video:', error));
            };

            document.getElementById('stopBtn').onclick = () => {
                fetch('/api/vlc/stop', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        isPlaying = false;
                        clearInterval(updateInterval);
                        updateInterval = null;
                        document.querySelector('.progress-bar').style.width = '0%';
                        document.getElementById('currentTime').textContent = '0:00';
                    }
                })
                .catch(error => console.error('Error stopping video:', error));
            };

            // Update progress function to use VLC status
            function updateProgress() {
                fetch('/api/vlc/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const position = data.position;
                            const duration = data.duration;
                            const progress = (position / duration) * 100;
                            
                            document.querySelector('.progress-bar').style.width = `${progress}%`;
                            document.getElementById('currentTime').textContent = formatTime(position);
                            document.getElementById('duration').textContent = formatTime(duration);
                            
                            isPlaying = data.state === 'State.Playing';
                        }
                    })
                    .catch(error => console.error('Error updating progress:', error));
            }

            // Handle volume control
            document.getElementById('volumeSlider').oninput = (e) => {
                const volume = e.target.value / 100;
                fetch('/api/vlc/volume', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ volume: volume })
                })
                .catch(error => console.error('Error setting volume:', error));
            };

            // Handle seeking
            document.querySelector('.progress').onclick = (e) => {
                if (!currentVideo) return;
                
                const rect = e.target.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                
                fetch('/api/vlc/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const duration = data.duration;
                            const newPosition = pos * duration;
                            
                            return fetch('/api/vlc/seek', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ position: newPosition })
                            });
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            updateProgress();
                        }
                    })
                    .catch(error => console.error('Error seeking video:', error));
            };
        }

        // Initialize VLC player when the page loads
        document.addEventListener('DOMContentLoaded', initVLCPlayer);
    </script>
</body>
</html> 